schema_version: "0.5.0"

before_install:

  environment:
    PYTHON: python
    RUN_ENV: anyci/run.sh

  appveyor:
    environment:
      PYTHON: $<PYTHON_DIR>\\python.exe
      RUN_ENV: .\\appveyor\\run-with-visual-studio.cmd
    commands:
      - python -m ci_addons appveyor/patch_vs2008
      - python -m ci_addons appveyor/tweak_environment

  travis:
    osx:
      environment:
        RUN_ENV: travis/run-with-pyenv.sh
      commands:
        - python -m ci_addons travis/install_pyenv

install:
  commands:
    - python -m ci_addons $<CI_NAME>/install_cmake 3.6.2
    - $<RUN_ENV> $<PYTHON> -m pip install --disable-pip-version-check --upgrade pip
    - $<RUN_ENV> $<PYTHON> -m pip install -r requirements.txt
    - $<RUN_ENV> $<PYTHON> -m pip install -r requirements-dev.txt

before_build:
  commands:
    - $<RUN_ENV> $<PYTHON> -m flake8

build:
  commands:
    - $<RUN_ENV> $<PYTHON> setup.py build

test:
  appveyor:
    environment:
      PATH: $<PYTHON_DIR>\\Scripts;$<PATH>

  commands:
    - $<RUN_ENV> $<PYTHON> setup.py test

    # Check CMake version
    - cmake --version
    - python -c "import subprocess as sp; import sys; sys.exit(0 if '3.6.2' in str(sp.check_output(['cmake', '--version'])) else 1)"

    # Check python interpreter found using $<RUN_ENV> wrapper script
    # is the expected one
    - $<RUN_ENV> $<PYTHON> _tests/python_check_version.py
    - $<RUN_ENV> $<PYTHON> _tests/python_check_arch.py

  circle:
    commands:
      - which cmake

  travis:
    linux:
      commands:
        - which cmake
    osx:
      commands:
        - which cmake

after_test:
  commands:
    - $<RUN_ENV> codecov -X gcov --required --file ./_tests/coverage.xml
    - $<RUN_ENV> $<PYTHON> setup.py bdist_wheel
